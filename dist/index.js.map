{"version":3,"file":"index.js","mappings":";;;;;;AAAA;;;;;;;;AAAA;;;;;;;;AAAA;;;;;;;;AAAA;;;;;;;;;ACAA;;;;;;;;ACAA;;;;;;ACAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AC7BA;AACA;;;;ACDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["../../../../AppData/Roaming/npm/node_modules/@vercel/ncc/dist/ncc/@@notfound.js","../external node-commonjs \"fs\"","../external node-commonjs \"path\"","../webpack/bootstrap","../webpack/runtime/compat",".././src/action.js"],"sourcesContent":[null,"module.exports = require(\"fs\");","module.exports = require(\"path\");","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\tvar threw = true;\n\ttry {\n\t\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\t\tthrew = false;\n\t} finally {\n\t\tif(threw) delete __webpack_module_cache__[moduleId];\n\t}\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","\nif (typeof __webpack_require__ !== 'undefined') __webpack_require__.ab = __dirname + \"/\";","const core = require(\"@actions/core\");\r\nconst github = require(\"@actions/github\");\r\nconst lfs_core = require(\"lightning-flow-scanner-core\");\r\nconst fs = require(\"fs\");\r\nconst path = require(\"path\");\r\nconst yaml = require(\"js-yaml\");\r\n\r\nconst CONFIG_PATHS = [\r\n  \".flow-scanner.yaml\",\r\n  \".flow-scanner.yml\",\r\n  \".flow-scanner.json\",\r\n  \"config/.flow-scanner.yaml\",\r\n  \"config/.flow-scanner.yml\",\r\n  \".flow-scanner\"\r\n];\r\n\r\nconst SEVERITY_LEVELS = [\"note\", \"warning\", \"error\"];\r\n\r\nasync function loadConfig() {\r\n  for (const configPath of CONFIG_PATHS) {\r\n    if (fs.existsSync(configPath)) {\r\n      core.info(`Found config file: ${configPath}`);\r\n      try {\r\n        const raw = fs.readFileSync(configPath, \"utf8\");\r\n        const ext = path.extname(configPath).toLowerCase();\r\n        if (ext === \".yaml\" || ext === \".yml\" || configPath === \".flow-scanner\") {\r\n          return yaml.load(raw);\r\n        } else if (ext === \".json\") {\r\n          return JSON.parse(raw);\r\n        }\r\n      } catch (err) {\r\n        core.warning(`Failed to parse config file ${configPath}: ${err.message}`);\r\n      }\r\n    }\r\n  }\r\n  core.info(\"No config file found. Using default scanner behavior.\");\r\n  return {};\r\n}\r\n\r\nfunction getSeverityThreshold(config) {\r\n  // First check workflow input\r\n  const thresholdInput = core.getInput(\"severityThreshold\");\r\n  if (SEVERITY_LEVELS.includes(thresholdInput)) {\r\n    core.info(`Using severity threshold from workflow input: ${thresholdInput}`);\r\n    return thresholdInput;\r\n  }\r\n\r\n  // Else check config file\r\n  if (config?.severityThreshold && SEVERITY_LEVELS.includes(config.severityThreshold)) {\r\n    core.info(`Using severity threshold from config file: ${config.severityThreshold}`);\r\n    return config.severityThreshold;\r\n  }\r\n\r\n  // Fallback\r\n  core.info(\"Using default severity threshold: warning\");\r\n  return \"warning\";\r\n}\r\n\r\nfunction meetsThreshold(severity, threshold) {\r\n  const sevIndex = SEVERITY_LEVELS.indexOf(severity);\r\n  const thIndex = SEVERITY_LEVELS.indexOf(threshold);\r\n  return sevIndex >= thIndex;\r\n}\r\n\r\nasync function run() {\r\n  const GITHUB_TOKEN = core.getInput(\"GITHUB_TOKEN\");\r\n  const octokit = github.getOctokit(GITHUB_TOKEN);\r\n  const { context } = github;\r\n  const repo = context.repo;\r\n\r\n  try {\r\n    let files = [];\r\n    let head_sha;\r\n\r\n    // Resolve commit SHA\r\n    if (context.eventName === \"pull_request\") {\r\n      head_sha = context.payload.pull_request.head.sha;\r\n    } else {\r\n      const { data: defaultBranch } = await octokit.rest.repos.getBranch({\r\n        owner: repo.owner,\r\n        repo: repo.repo,\r\n        branch: \"master\"\r\n      });\r\n      head_sha = defaultBranch.commit.sha;\r\n    }\r\n\r\n    // Collect flow files\r\n    if (context.eventName === \"pull_request\") {\r\n      const pull_number = context.payload.pull_request.number;\r\n      const { data: prFiles } = await octokit.rest.pulls.listFiles({\r\n        owner: repo.owner,\r\n        repo: repo.repo,\r\n        pull_number\r\n      });\r\n      files = prFiles\r\n        .map(file => file.filename)\r\n        .filter(file => file.endsWith(\"flow-meta.xml\") || file.endsWith(\"flow\"));\r\n    } else {\r\n      const { data: latestCommit } = await octokit.rest.repos.listCommits({\r\n        owner: repo.owner,\r\n        repo: repo.repo,\r\n        per_page: 1\r\n      });\r\n      const latestCommitSha = latestCommit[0].sha;\r\n\r\n      const { data: tree } = await octokit.rest.git.getTree({\r\n        owner: repo.owner,\r\n        repo: repo.repo,\r\n        tree_sha: latestCommitSha,\r\n        recursive: true\r\n      });\r\n\r\n      files = tree.tree\r\n        .filter(\r\n          item =>\r\n            item.type === \"blob\" &&\r\n            (item.path.endsWith(\"flow-meta.xml\") || item.path.endsWith(\"flow\"))\r\n        )\r\n        .map(item => item.path);\r\n    }\r\n\r\n    // Load scanner config\r\n    const config = await loadConfig();\r\n    const severityThreshold = getSeverityThreshold(config);\r\n\r\n    // Parse flows\r\n    let pFlows = [];\r\n    for (const file of files) {\r\n      pFlows.push(...(await lfs_core.parse([file])));\r\n    }\r\n\r\n    if (pFlows.length > 0) {\r\n      console.log(\"Scanning \" + pFlows.length + \" Flows...\");\r\n      let scanResults = [];\r\n      for (let flow of pFlows) {\r\n        // Pass IRulesConfig into scanner\r\n        const res = lfs_core.scan([flow], config);\r\n        scanResults.push(...res);\r\n      }\r\n\r\n      if (scanResults) {\r\n        const tableRows = [];\r\n        const thresholdViolations = [];\r\n\r\n        for (let scanResult of scanResults) {\r\n          if (scanResult.ruleResults.length > 0) {\r\n            for (let ruleResult of scanResult.ruleResults) {\r\n              if (ruleResult.occurs) {\r\n                let details = ruleResult.details;\r\n                if (Array.isArray(details) && details.length > 0) {\r\n                  for (let detail of details) {\r\n                    const severity =\r\n                      config.rules?.[ruleResult.ruleName]?.severity ||\r\n                      ruleResult.severity ||\r\n                      \"warning\"; \r\n                    const row = {\r\n                      flow: scanResult.flow.name,\r\n                      violation: detail.name || \"\",\r\n                      rule: ruleResult.ruleName,\r\n                      type: detail.type || \"\",\r\n                      severity\r\n                    };\r\n                    tableRows.push(row);\r\n\r\n                    if (meetsThreshold(severity, severityThreshold)) {\r\n                      thresholdViolations.push(row);\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n\r\n        core.setOutput(\"scanResults\", tableRows);\r\n        if (tableRows.length > 0) {\r\n          console.table(tableRows, [\"flow\", \"violation\", \"type\", \"rule\", \"severity\"]);\r\n        }\r\n\r\n        if (thresholdViolations.length > 0) {\r\n          core.setFailed(\r\n            `${thresholdViolations.length} violations at severity >= ${severityThreshold} in ${pFlows.length} Flows.`\r\n          );\r\n        } else {\r\n          core.info(\r\n            `0 violations at severity >= ${severityThreshold} in ${pFlows.length} Flows.`\r\n          );\r\n        }\r\n      }\r\n    } else {\r\n      core.info(`No Flows identified within the repository..`);\r\n    }\r\n  } catch (e) {\r\n    console.error(e);\r\n    core.setFailed(e.message);\r\n  }\r\n}\r\n\r\nrun();\r\n"],"names":[],"sourceRoot":""}